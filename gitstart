#!/usr/bin/env bash

# This script automate git repo
# You must install GitHub CLI https://cli.github.com/manual/.
# Install yq https://github.com/mikefarah/yq
# Choose SSH as the default git protocol.

# Usage
# mkdir my_new_repo
# cd my_new_repo
# gitstart python


unset user dir repo license_url

user=$(yq e '."github.com".user' "$HOME"/.config/gh/hosts.yml)
dir="$PWD"
repo=$(basename "$dir")
license_url="mit"
echo ">>> Your github username is ${user}."

PS3='Your lisence: '
lisences=("MIT: I want it simple and permissive." "Apache License 2.0: I need to work in a community." "GNU GPLv3: I care about sharing improvements." "Quit")

echo "Select a license: "
select license in "${lisences[@]}"; do
    case $license in
        "MIT: I want it simple and permissive.")
        echo "MIT"
        break
        ;;
        "Apache License 2.0: I need to work in a community.")
        echo "Apache"
        license_url="apache-2.0"
        break
        ;;
        "GNU GPLv3: I care about sharing improvements.")
        echo "GNU"
        license_url="lgpl-3.0"
        break
        ;;
        "Quit")
        echo "User requested exit."
        exit;;
        *) echo "Invalid option $REPLY"
    esac
done

curl -s "https://api.github.com/licenses/$license_url" | jq -r '.body' > "$dir"/license.txt

if [[ $1 ]]; then
    # github gitignore url
    url=https://raw.githubusercontent.com/github/gitignore/master/"${1^}".gitignore
    # get the status http code, 200, 404 etc.
    http_status=$(curl --write-out '%{http_code}' --silent --output /dev/null "$url")

    if [[ $http_status -eq 200 ]]; then
        # get argument e.g python, go etc, capitalize it
        echo ">>> Creating .gitignore for ${1^}..."
        # create .gitignore
        curl "$url" -o .gitignore
        echo ">>> .gitignore created."
    else
        echo ">>> Not able to find ${1^} gitignore at https://github.com/github/gitignore."
        exit 1
    fi
fi

echo ">>> Creating READMR.md."
printf "# %s \n 
## Overview \n\n 
## Requirement \n\n
## Usage \n\n 
## Features \n\n 
## Reference \n\n 
## Author \n\n 
## Licence

Please see license.txt. \n" "$repo" > README.md
echo ">>> Running git init."
git init
echo ">>> Adding README.md and .gitignore."
git add .
echo ">>> Commiting with a message 'first commit'."
git commit -m "first commit"
echo ">>> Creating the main branch."
git branch -M main


# check if you are logged in
if [[ $(gh auth status) -eq 1 ]]; then
    # not logged-in
    echo ">>> You must logged in. Use 'gh auth login'"
    exit 1
else
    echo ">>> You are logged in. Creating your ${repo} in remote."
    gh repo create "$repo"
    git remote add origin git@github.com:"$user"/"$repo".git
    echo ">>> Pushing local repo to the remote."
    git push -u origin main
    echo ">>> You have created a github repo at https://github.com/$user/$repo"
fi

